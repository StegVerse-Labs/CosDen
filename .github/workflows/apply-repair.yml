name: Apply Repair Plan From StegDB

on:
  workflow_dispatch: {}

jobs:
  apply-repair:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout CosDen repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout StegDB
        uses: actions/checkout@v4
        with:
          repository: StegVerse-Labs/StegDB
          path: stegdb
          fetch-depth: 0

      - name: Check for repair plan
        id: check_plan
        run: |
          if [ -f stegdb/repairs/CosDen/repair_plan.json ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: No repair plan found — exit cleanly
        if: steps.check_plan.outputs.found == 'false'
        run: |
          echo "✔ No repair plan found — CosDen is already canonical."
          exit 0

      - name: Apply repair plan
        if: steps.check_plan.outputs.found == 'true'
        run: |
          python - << 'PY'
          import json, pathlib, shutil

          repo_root = pathlib.Path(".").resolve()
          stegdb_root = repo_root / "stegdb"

          plan_path = stegdb_root / "repairs" / "CosDen" / "repair_plan.json"
          with plan_path.open("r", encoding="utf-8") as f:
              plan = json.load(f)

          actions = plan.get("actions", [])
          if not actions:
              print("No actions in repair plan; nothing to do.")
          else:
              print(f"Applying {len(actions)} repair actions...")
          
          for action in actions:
              atype = action.get("type")
              if atype == "move_file":
                  src_rel = action["from"]
                  dst_rel = action["to"]
                  src = repo_root / src_rel
                  dst = repo_root / dst_rel
                  print(f" - move_file: {src_rel} -> {dst_rel}")
                  if not src.exists():
                      print(f"   ⚠ Source does not exist, skipping: {src_rel}")
                      continue
                  dst.parent.mkdir(parents=True, exist_ok=True)
                  shutil.move(str(src), str(dst))
              elif atype == "write_file":
                  # keep previous behavior if we ever use canonical exports
                  canonical_root = stegdb_root / plan["canonical_root"]
                  rel = action["canonical_relpath"]
                  target = action["target_path"]
                  src = canonical_root / rel
                  dst = repo_root / target
                  print(f" - write_file: {rel} -> {target}")
                  dst.parent.mkdir(parents=True, exist_ok=True)
                  shutil.copy2(src, dst)
              else:
                  print(f"   ⚠ Unknown action type: {atype} (ignoring)")
          PY

      - name: Set up Python for validation
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps for validation
        run: |
          python -m pip install --upgrade pip
          pip install pydantic fastapi uvicorn

      - name: Run CosDen validator (build mode)
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python tools/validate_cosden_structure.py --mode=build

      - name: Create pull request with repairs
        if: steps.check_plan.outputs.found == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Apply StegDB repair plan"
          title: "Apply StegDB repair plan"
          body: "Automated repair application for CosDen."
          branch: "repair/from-stegdb"
          labels: "repair,auto"
