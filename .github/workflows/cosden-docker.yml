name: CosDen Docker Build (PROD-gated)

on:
  # Manual run
  workflow_dispatch:

  # Auto-run on changes to core CosDen sources or Dockerfile
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "src/**"
      - ".github/workflows/cosden-docker.yml"

permissions:
  contents: read

jobs:
  # ðŸ”’ 1) Global cluster gate (StegBrain)
  stegguard:
    name: StegBrain prod gate
    uses: StegVerse-Labs/StegBrain/.github/workflows/stegbrain-gate.yml@main

  # ðŸ§ª 2) Build CosDen Docker image (no push yet)
  build:
    name: Build CosDen Docker image
    needs: stegguard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CosDen
        uses: actions/checkout@v4

      - name: Compute image tag
        id: metadata
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="cosden:${SHORT_SHA}"
          echo "image_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using image tag: $TAG"

      - name: Quick Python sanity check
        run: |
          if [ -d "src" ]; then
            python -m compileall src || {
              echo "Python syntax errors detected."
              exit 1
            }
          else
            echo "No src/ directory found; skipping compile check."
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ${{ steps.metadata.outputs.image_tag }}
