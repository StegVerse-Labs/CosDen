name: CosDen Docker Build (PROD-gated)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  # ðŸ”’ StegGuard â€” checks StegDB dependency_status.json
  # and blocks deploy if CosDen is not PROD-safe.
  stegguard:
    uses: ./.github/workflows/stegguard-prod-gate.yml
    with:
      repo_name: CosDen

  # ðŸš€ Only runs if StegGuard passes
  docker-build:
    needs: stegguard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CosDen
        uses: actions/checkout@v4

      # Optional: if you need Python for tests or tooling, keep this.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ðŸ§± Build Docker image (local only â€“ no push yet)
      - name: Build CosDen Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: |
            cosden:latest

      # âœ… Optional sanity check â€“ run container and exit
      - name: Run container smoke test
        run: |
          docker run --rm cosden:latest echo "CosDen container started OK"

      # ðŸ“¦ Placeholder for real deploy step (registry / Render / etc.)
      # When you're ready to actually publish, add your push/deploy
      # commands below this comment, still in the docker-build job.
      - name: Deploy placeholder
        run: |
          echo "âœ… CosDen Docker image built successfully (no deploy configured yet)."
