name: CosDen Docker Build (PROD-gated)

on:
  # Manual run
  workflow_dispatch:

  # Auto-run on changes to core CosDen sources or Dockerfile
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "src/**"
      - ".github/workflows/cosden-docker.yml"

permissions:
  contents: read

jobs:
  # ðŸ”’ Global cluster gate, lives in StegBrain
  stegguard:
    name: StegBrain prod gate
    uses: StegVerse-Labs/StegBrain/.github/workflows/stegbrain-gate.yml@main

  # ðŸ§ª Lightweight build that only runs if StegBrain allows it
  build:
    name: Build CosDen Docker image
    needs: stegguard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CosDen
        uses: actions/checkout@v4

      # Optional: very cheap Python syntax check
      - name: Quick Python sanity check
        run: |
          if [ -d "src" ]; then
            python -m compileall src || {
              echo "Python syntax errors detected."
              exit 1
            }
          else
            echo "No src/ directory found; skipping compile check."
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: cosden:prod-gated-test
